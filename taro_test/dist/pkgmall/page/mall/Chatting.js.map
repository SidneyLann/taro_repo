{"version":3,"file":"pkgmall/page/mall/Chatting.js","mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACzUA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","sources":["webpack://i_bizz_client/./src/pkgmall/page/mall/Chatting.tsx?4411","webpack://i_bizz_client/._src_pkgmall_page_mall_Chatting.tsx"],"sourcesContent":["import _toConsumableArray from \"c:/taro/i_bizz_client/node_modules/@babel/runtime/helpers/esm/toConsumableArray.js\";\nimport _objectSpread from \"c:/taro/i_bizz_client/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";\nimport _callSuper from \"c:/taro/i_bizz_client/node_modules/@babel/runtime/helpers/esm/callSuper.js\";\nimport _inherits from \"c:/taro/i_bizz_client/node_modules/@babel/runtime/helpers/esm/inherits.js\";\nimport _defineProperty from \"c:/taro/i_bizz_client/node_modules/@babel/runtime/helpers/esm/defineProperty.js\";\nimport _createClass from \"c:/taro/i_bizz_client/node_modules/@babel/runtime/helpers/esm/createClass.js\";\nimport _classCallCheck from \"c:/taro/i_bizz_client/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";\nimport React from \"react\";\nimport JsUtil from 'tsx/common/JsUtil';\nimport cnst from 'tsx/common/Constant';\nimport HeadLayout from 'tsx/layout/HeadLayout';\nimport BrView from 'tsx/view/BrView';\nimport RowLayout from 'tsx/layout/RowLayout';\nimport ColumnLayout from 'tsx/layout/ColumnLayout';\nimport ImagePicker from 'tsx/form/ImagePicker';\nimport TextLabel from 'tsx/view/TextLabel';\nimport LegenImage from 'tsx/view/LegenImage';\nimport GeneralInput from 'tsx/form/GeneralInput';\nimport { jsx as _jsx, jsxs as _jsxs } from \"react/jsx-runtime\";\nvar Message = /*#__PURE__*/_createClass(function Message() {\n  _classCallCheck(this, Message);\n  this.buyerUserId = '';\n  this.buyerUserName = '';\n  this.sellerUserId = '';\n  this.sellerUserName = '';\n  this.interactContent = '';\n  this.directType = 1; // 1顾客发的，3商家发的\n  this.contentType = 1; // 1文本，3图片\n  this.orgId = '';\n});\nvar Chatting = /*#__PURE__*/function (_React$Component) {\n  function Chatting(props) {\n    var _this;\n    _classCallCheck(this, Chatting);\n    _this = _callSuper(this, Chatting, [props]);\n    _defineProperty(_this, \"errors\", {\n      interactContent: false\n    });\n    _defineProperty(_this, \"params\", JsUtil.getUrlParams(_this));\n    _defineProperty(_this, \"currUserId\", JsUtil.getAppItem('currUserId'));\n    _defineProperty(_this, \"currOrgId\", JsUtil.getAppItem('currOrgId'));\n    _defineProperty(_this, \"initWebSocket\", function () {\n      var token = JsUtil.getAppItem('token');\n      var orgId = _this.params.orgId;\n      var orgName = _this.params.orgName;\n      var buyerUserId = _this.params.buyerUserId;\n      var buyerUserName = _this.params.buyerUserName;\n      var sellerUserId = _this.params.sellerUserId;\n      var sellerUserName = _this.params.sellerUserName;\n      var directType = _this.params.directType;\n      var status = 1;\n\n      // 初始化websocket\n      var url = '';\n      if (directType == 3) {\n        url = \"wss://www.pc8g.com:443/pcng-biz-member/websocket/service?token=\".concat(token, \"&orgId=\").concat(orgId, \"&buyerUserId=\").concat(buyerUserId);\n        status = 3;\n      } else {\n        buyerUserId = _this.currUserId;\n        buyerUserName = JsUtil.getAppItem('currUserName');\n        url = \"wss://www.pc8g.com:443/pcng-biz-member/websocket/service?token=\".concat(token, \"&orgId=\").concat(orgId);\n      }\n      console.log(url);\n      // 初始化消息模板\n      _this.message = _objectSpread(_objectSpread({}, _this.message), {}, {\n        mallType: _this.params.mallType,\n        orgId: orgId,\n        orgName: orgName,\n        buyerUserName: buyerUserName,\n        buyerUserId: buyerUserId,\n        sellerUserId: sellerUserId,\n        sellerUserName: sellerUserName,\n        directType: directType,\n        status: status\n      });\n      var websocket;\n      if (process.env.TARO_ENV === cnst.TARO_ENV_WEAPP) {\n        websocket = wx.connectSocket({\n          url: url\n        });\n      } else if (process.env.TARO_ENV === 'h5') {\n        websocket = new WebSocket(url);\n      } else {\n        websocket = new WebSocket(url);\n      }\n      var that = _this;\n      if (process.env.TARO_ENV === cnst.TARO_ENV_WEAPP) {\n        websocket.onOpen(function (res) {\n          console.log('WebSocket连接已打开！');\n        });\n        websocket.onMessage(function (res) {\n          console.log('onMessage');\n          var msg = JSON.parse(res.data);\n          msg.from = false;\n          if (msg.directType == 3) {\n            that.message.sellerUserId = msg.sellerUserId;\n            that.message.sellerUserName = msg.sellerUserName;\n          }\n          that.setState(function (pre) {\n            return {\n              entities: [].concat(_toConsumableArray(pre.entities), [msg])\n            };\n          });\n        });\n        websocket.onError(function (res) {\n          console.log('onError！');\n        });\n        websocket.onClose(function (res) {\n          console.log('onClose！');\n          if (process.env.TARO_ENV === cnst.TARO_ENV_WEAPP) {\n            websocket = wx.connectSocket({\n              url: url\n            });\n          } else if (process.env.TARO_ENV === 'h5') {\n            websocket = new WebSocket(url);\n          } else {\n            websocket = new WebSocket(url);\n          }\n          that.setState({\n            websocket: websocket\n          });\n        });\n      } else {\n        websocket.onopen = function (event) {\n          that.setState({\n            isOpen: true\n          });\n          console.log('WebSocket5连接已打开！');\n        };\n        websocket.onmessage = function (event) {\n          console.log('onMessage');\n          var msg = JSON.parse(event.data);\n          msg.from = false;\n          if (msg.directType == 3) {\n            that.message.sellerUserId = msg.sellerUserId;\n            that.message.sellerUserName = msg.sellerUserName;\n          }\n          that.setState(function (pre) {\n            return {\n              entities: [].concat(_toConsumableArray(pre.entities), [msg])\n            };\n          });\n        };\n        websocket.onerror = function (event) {\n          console.log('onError！');\n        };\n        websocket.onclose = function (event) {\n          console.log('onClose！');\n          if (process.env.TARO_ENV === cnst.TARO_ENV_WEAPP) {\n            websocket = wx.connectSocket({\n              url: url\n            });\n          } else if (process.env.TARO_ENV === 'h5') {\n            websocket = new WebSocket(url);\n          } else {\n            websocket = new WebSocket(url);\n          }\n          that.setState({\n            websocket: websocket\n          });\n        };\n      }\n      _this.setState({\n        websocket: websocket\n      });\n    });\n    _defineProperty(_this, \"search\", function () {\n      if (_this.params.directType != 3) return;\n      var params = {\n        id: _this.params.id,\n        orgId: _this.params.orgId\n      };\n      var succ = function succ(result) {\n        if (JsUtil.handleMessage(_this, result)) {\n          var data = result.body;\n          var disabled = false;\n          if (_this.params.status == 3) disabled = true;\n          _this.setState({\n            entities: data,\n            totalRecords: result.totalRecords,\n            disabled: disabled\n          });\n        }\n      };\n      var err = function err(result) {\n        JsUtil.handleMessage(_this, result);\n      };\n      JsUtil.asyncHttpPost(_this, \"/ml/pub/customer/service/search\", JSON.stringify(params), succ, err);\n    });\n    _defineProperty(_this, \"onInputChanged\", function (name, value) {\n      _this.setState(_defineProperty({}, name, value));\n    });\n    _defineProperty(_this, \"handleClickSend\", function () {\n      var _this$state = _this.state,\n        websocket = _this$state.websocket,\n        isOpen = _this$state.isOpen,\n        interactContent = _this$state.interactContent;\n      if (!isOpen) {\n        alert('连接未建立,请稍等');\n        return;\n      }\n      if (!interactContent) {\n        return;\n      }\n      var msg = _objectSpread({}, _this.message);\n      msg.interactContent = interactContent;\n      msg.from = true;\n      websocket.send({\n        data: JSON.stringify(msg)\n      });\n      _this.setState(function (pre) {\n        return {\n          entities: [].concat(_toConsumableArray(pre.entities), [msg]),\n          interactContent: ''\n        };\n      });\n    });\n    _defineProperty(_this, \"onImageFileChanged\", function (newValue, opType, uriOrIdx) {\n      if ('add' == opType) {\n        _this.setState({\n          imageUri: uriOrIdx\n        });\n        _this.handleChangePic(uriOrIdx);\n      } else if ('rm' == opType) {\n        _this.setState({\n          imageUri: ''\n        });\n      }\n      _this.setState({\n        imageFile: newValue\n      });\n    });\n    _defineProperty(_this, \"handleChangePic\", function (imageUri) {\n      var _this$state2 = _this.state,\n        websocket = _this$state2.websocket,\n        isOpen = _this$state2.isOpen;\n      if (!isOpen) {\n        alert('连接未建立,请稍等');\n        return;\n      }\n      var msg = _objectSpread({}, _this.message);\n      msg.interactContent = imageUri;\n      msg.contentType = 3;\n      msg.from = true;\n      websocket.send({\n        data: JSON.stringify(msg)\n      });\n      _this.setState(function (pre) {\n        return {\n          entities: [].concat(_toConsumableArray(pre.entities), [msg])\n        };\n      });\n    });\n    _this.state = {\n      path: '',\n      entities: [],\n      interactContent: '',\n      imageUri: '',\n      imageFile: [],\n      disabled: false,\n      isOpen: false,\n      websocket: undefined\n    };\n    _this.message = new Message();\n    return _this;\n  }\n  _inherits(Chatting, _React$Component);\n  return _createClass(Chatting, [{\n    key: \"componentDidMount\",\n    value: function componentDidMount() {\n      this.search();\n      this.initWebSocket();\n    }\n  }, {\n    key: \"render\",\n    value: function render() {\n      var _this2 = this;\n      var _this$state3 = this.state,\n        entities = _this$state3.entities,\n        interactContent = _this$state3.interactContent,\n        imageUri = _this$state3.imageUri;\n      return /*#__PURE__*/_jsxs(HeadLayout, {\n        topNavBarTitle: '客服会话',\n        that: this,\n        postFunc: this.handleChangePic,\n        bottomLabel4: '发送',\n        bottomFunc4: this.handleClickSend,\n        children: [/*#__PURE__*/_jsx(ColumnLayout, {\n          justifyContent: 'flex-end',\n          children: entities.map(function (item) {\n            var isFrom = item.directType == 1 && item.buyerUserId == _this2.currUserId || item.directType == 3 && item.orgId == _this2.currOrgId ? true : false;\n            var justifyContent = isFrom == true ? 'flex-end' : 'flex-start';\n            var bcolor = isFrom == true ? 'COLOR_BACKGROUND_NEAR_WHITE' : 'COLOR_BACKGROUND_WHITE';\n            return item.contentType == 3 ? /*#__PURE__*/_jsx(LegenImage, {\n              src: JsUtil.IMAGE_PREFIX + item.interactContent,\n              width: cnst.NUM_WIDTH_MAIN,\n              height: -33\n            }) : /*#__PURE__*/_jsx(RowLayout, {\n              justifyContent: justifyContent,\n              backgroundColor: bcolor,\n              children: /*#__PURE__*/_jsx(TextLabel, {\n                children: item.interactContent\n              })\n            });\n          })\n        }), /*#__PURE__*/_jsx(BrView, {\n          height: 10,\n          backgroundColor: cnst.COLOR_BACKGROUND_NEAR_WHITE\n        }), /*#__PURE__*/_jsx(GeneralInput, {\n          name: 'interactContent',\n          label: '回复内容',\n          type: 'text',\n          value: this.state.interactContent,\n          error: this.errors.interactContent,\n          onChange: this.onInputChanged,\n          focus: true,\n          disabled: this.state.disabled\n        }), /*#__PURE__*/_jsx(ImagePicker, {\n          that: this,\n          files: this.state.imageFile,\n          onChange: this.onImageFileChanged,\n          count: 1,\n          category: cnst.BIZZ_CAT_SUBJECT,\n          disabled: false\n        })]\n      });\n    }\n  }]);\n}(React.Component);\nexport default Chatting;","import { createPageConfig } from '@tarojs/runtime'\nimport component from \"!!../../../../node_modules/@tarojs/taro-loader/lib/entry-cache.js?name=pkgmall/page/mall/Chatting!./Chatting.tsx\"\nvar config = {};\n\n\nvar inst = Page(createPageConfig(component, 'pkgmall/page/mall/Chatting', {root:{cn:[]}}, config || {}))\n\n\nexport default component\n"],"names":[],"sourceRoot":""}